<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="theme-color content=#0080ff">
        <link rel="manifest" href="manifest.json">
        <link rel="icon" href="icons/icon-192.png" type="image/x-icon">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
    </head>

    <body>

<p>v6.1 Î²-25</p>

<button id="readFolder">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€</button>
<button id="selectFolder">èª­ã¿è¾¼ã¿å…ˆ:</button>

<br>
<p id="folderLoad">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</p>

<p id="clock"></p>

<label for="volumeBar">éŸ³é‡</label>
<input type="range" id="volumeBar" min="0" max="100" step="0.1" value="10">
<input type="number" id="volumeInput" min="0" max="100" step="0.1" value="10">

<label for="muteCheckBox">ãƒŸãƒ¥ãƒ¼ãƒˆã™ã‚‹</label>

<input type="checkbox" id="muteCheckBox" disabled="true">

<p id="volume">volume</p>


<button onclick="settingDialog.showModal()" id="configSettings">è¨­å®š</button>

<dialog id="settingDialog">
    <input type="checkbox" id="sceneSelectBool">
    <label for="sceneSelectBool">SceneSelect</label>
    <br>

    <input type="checkbox" id="timeSignalBool">
    <label for="timeSignalBool">timeSignal</label>
    <br>

    <input type="checkbox" id="bgmBool">
    <label for="bgmBool">BGM</label>
    <br>
    <br>

    <input type="number" min="0" max="12" value="0" id="sceneSelectRange">
    <label for="sceneSelectRange">æ™‚:ç¾åœ¨ã®æ™‚åˆ»Â±ã“ã®æ™‚é–“ã®æ›²ãŒæµã‚Œã‚‹</label>
    <br>

    <input type="number" min="-12" max="12" value="9" id="timeZone">
    <label for="timeZone">æ™‚:ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³(UTC)</label>
    <br>

    <input type="number" min="0" max="3600" value="60" id="betweenSong">
    <label for="betweenSong">ç§’:æ›²ãŒçµ‚ã‚ã£ã¦ã‹ã‚‰æ¬¡ã®æ›²ãŒå†ç”Ÿã•ã‚Œã‚‹ã¾ã§</label>
    <br>

    <input type="number" min="0" max="3600" value="10" id="leastToSignal">
    <label for="leastToSignal">ç§’:æ›²ã‹ã‚‰æ™‚å ±ã¾ã§ã®æœ€å°</label>
    <br>

    <!--minPlayedã‹ã‚‰ä½•å›åˆ†ã¾ã§è¨±å®¹ã™ã‚‹ã‹ã€åŒã˜æ›²ãŒæ¬¡ç¾ã‚Œã‚‹ã¾ã§ã®é•·ã•-->
    <input type="number" min="0" max="100" value="0" id="leastPlayed">
    <label for="leastPlayed">å›:å†ç”Ÿå›æ•°ãŒæœ€ã‚‚å°‘ãªã„ã‚‚ã®ã‹ã‚‰ä½•å›å¤šã„ã‚‚ã®ã¾ã§è¨±å®¹ã™ã‚‹ã‹</label>
    <br>

    <input type="number" min="0" max="300" value="30" id="timeBetweenPlay">
    <label for="timeBetweenPlay">åˆ†:åŒã˜æ›²ã‚’å†ç”Ÿã™ã‚‹ã¨ãã®é–“éš”</label>
    <br>

    <button onclick="saveSetting()" id="saveSettingJson">ä¿å­˜</button>
    <br>
    <br>

    <input type="checkbox" id="sleepMode">
    <label for="sleepMode">ä¼‘æ­¢ãƒ¢ãƒ¼ãƒ‰:åˆ†</label>
    <input type="number" id="sleepModeInput" min="0" max="1440" value="60">

    <br>
    <br>

    <input type="checkbox" id="weatherInternet">
    <label for="weatherInternet">ğŸŒï¸ | å¤©æ°—</label>
    <select id="weatherInput" name="weather">
        <option value="0">None</option>
        <option value="1">Clear</option>
        <option value="2">Clouds</option>
        <option value="3">Rain</option>
        <option value="4">Snow</option>
    </select>
    <br>

    <input type="checkbox" id="speedInternet">
    <label for="speedInternet">ğŸŒï¸ | é€Ÿåº¦</label>
    <input type="number" id="speedInput" min="0" max="2550" value="0">
    <br>

    <button onclick="settingDialog.close()">close</button>
</dialog>
<br>

<button id="startButton">é–‹å§‹</button>

<p id="nowPlaying" style="font-weight: bold;">nowPlaying</p>

<audio id="audioPlayerM" controls style="display:none;">audioM</audio>
<video id="videoPlayerM" controls width="480" style="display:none;">videoM</video>

<audio id="audioPlayerJ" controls style="display: none;">audioJ</audio>
<video id="videoPlayerJ" controls width="480" style="display: none;">videoJ</video>

<audio id="audioPlayerB" controls style="display:none;">audioB</audio>
<video id="videoPlayerB" controls width="480" style="display:none;">videoB</video>

<audio id="SE_Audio" controls style="display: none;"></audio>

<br>

<p id="sleepModeMessage"></p>




<button onclick="fileDialog.showModal()" id="showProperty">å‹•ç”»/éŸ³å£°ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¡¨ç¤º</button>

<dialog id="fileDialog">
    <h2 id="pathDialog">path:</h2>
    <p id="nameDialog">name:</p>
    <p id="coverDialog">cover:</p>
    <p id="originalDialog">original:</p>
    <p id="timeDialog">time:</p>
    <p id="signalDialog">signal:</p>
    <p id="travelDialog">travel:</p>
    <p id="travelOnlyDialog">travelOnly:</p>
    <p id="weatherDialog">weather:</p>
    <p id="durationDialog">duration:</p>
    <p id="registeredDialog">registered:</p>
    <p id="languageDialog">language:</p>
    <p id="playedDialog">played:</p>
    <a id="sourceDialog" href=""></a>
    <br>
    <button onclick="fileDialog.close()">close</button>
</dialog>

    </body>

    <style>

dialog {
    border: none;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
dialog::backdrop {
    background: rgba(0,0,0,0.5);
}
.showAfterInput {
    display: none;
}
.showAfterStarted {
    display: none;
}
.controlableAfterInput {
    pointer-events: auto;/*é©å½“ãªè¦ç´ ã‚’å…¥ã‚Œãªã„ã¨ã„ã‘ãªã„ã®ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚‚ã®ã‚’å…¥ã‚Œã‚‹*/
}


    </style>

    <script>

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
        .then(() => console.debug("SW registered"))
        .catch(err => console.error("SW fail:", err));
}



const folderInput = document.getElementById("folderInput")//ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¥åŠ›ã™ã‚‹ã¨ã“ã‚
const startButton = document.getElementById("startButton")//é–‹å§‹ãƒœã‚¿ãƒ³
const clock = document.getElementById("clock")
const readFolder = document.getElementById("readFolder")
const timezoneInput = document.getElementById("timeZone")

const audioM = document.getElementById("audioPlayerM")
const videoM = document.getElementById("videoPlayerM")
const audioB = document.getElementById("audioPlayerB")
const videoB = document.getElementById("videoPlayerB")
const audioJ = document.getElementById("audioPlayerJ")
const videoJ = document.getElementById("videoPlayerJ")
const audioSE = document.getElementById("SE_Audio")

let isInSleepMode = false
let idleTimer
let haveSetMusic = false
let haveSetSignal = false

/*ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®Show/Hide/Disabled*/
function hide() {
    document.querySelectorAll(".showAfterInput").forEach(element => {
        element.style.display = "none";
    })
    
    document.querySelectorAll(".showAfterStarted").forEach(element => {
        element.style.display = "none"
    })

    document.querySelectorAll(".controlableAfterInput").forEach(element => {
        element.disabled = true;
    })
}

function showAfterInput() {

    document.querySelectorAll(".showAfterInput").forEach(element => {
        element.style.display = "block";
    })

    document.querySelectorAll(".controlableAfterInput").forEach(element=>{
        element.disabled = false;
    })
}

function showAfterstarted() {
    document.querySelectorAll(".showAfterStarted").forEach(element => {
        element.style.display = "block"
    })
}

startButton.addEventListener("click",showAfterstarted)

document.addEventListener("DOMContentLoaded",function() {
    onDOMContentLoaded()
})

function onDOMContentLoaded() {
    document.getElementById("volumeBar").disabled = true
    document.getElementById("volumeInput").disabled = true
    document.getElementById("muteCheckBox").disabled = true
    document.getElementById("configSettings").style.display = "none"
    document.getElementById("showProperty").style.display = "none"
    document.getElementById("nowPlaying").style.display = "none"
    document.getElementById("speedInternet").disabled = true
    document.getElementById("weatherInternet").disabled = true
    document.getElementById("sleepMode").disabled = false
    document.getElementById("sleepModeInput").disabled = false
    document.getElementById("startButton").disabled = true

}

function onFileLoaded() {
    document.getElementById("readFolder").disabled = true
    document.getElementById("selectFolder").disabled = true
    document.getElementById("configSettings").style.display = "block"
    document.getElementById("startButton").disabled = false

}

function onStarted() {
    document.getElementById("volumeBar").disabled = false
    document.getElementById("volumeInput").disabled = false
    document.getElementById("muteCheckBox").disabled = false
    document.getElementById("showProperty").style.display = "block"
    document.getElementById("nowPlaying").style.display = "block"
    document.getElementById("sceneSelectBool").disabled = true
    document.getElementById("timeSignalBool").disabled = true
    document.getElementById("bgmBool").disabled = true
    document.getElementById("sceneSelectRange").disabled = true
    document.getElementById("timeZone").disabled = true
    document.getElementById("betweenSong").disabled = true
    document.getElementById("leastToSignal").disabled = true
    document.getElementById("leastPlayed").disabled = true
    document.getElementById("timeBetweenPlay").disabled = true
    document.getElementById("sleepMode").disabled = true
    document.getElementById("sleepModeInput").disabled = true
    document.getElementById("saveSettingJson").disabled = true
    document.getElementById("startButton").disabled = true


}
/**/

/*jsonã®ä¿å­˜*/
async function saveSetting() {
    const sceneSelectValue = document.getElementById("sceneSelectBool").checked
    const timeSignalValue = document.getElementById("timeSignalBool").checked
    const bgmValue = document.getElementById("bgmBool").checked

    const sceneSelectRangeValue = document.getElementById("sceneSelectRange").value-0
    const timeZoneValue = document.getElementById("timeZone").value-0
    const betweenSongValue = document.getElementById("betweenSong").value*1000
    const leastToSignalValue = document.getElementById("leastToSignal").value*1000
    const leastPlayedValue = document.getElementById("leastPlayed").value
    const timeBetweenPlayValue = document.getElementById("timeBetweenPlay").value



    try {
        const data = await db.get("InputFolderPath","path")

        const settingsHandle = await data.handle.getFileHandle("Settings.json")

        const writable = await settingsHandle.createWritable()

        const jsonData = {
            "sceneSelect":sceneSelectValue,
            "timeSignal":timeSignalValue,
            "bgm":bgmValue,
            "sceneSelectRange":sceneSelectRangeValue,
            "timezone":timeZoneValue,
            "betweenSong":betweenSongValue,
            "leastToSignal":leastToSignalValue,
            "leastPlayed":leastPlayedValue,
            "timeBetweenPlay":timeBetweenPlayValue
        }


        const jsonContent = JSON.stringify(jsonData)

        await writable.write(jsonContent)

        await writable.close()

        alert("ä¿å­˜ã—ã¾ã—ãŸ")
    } catch (error) {
        if (error.name === "NotAllowedError") {
            await data.requestPermission({mode:"readwrite"})
            alert("ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒã‚ã‚Šã¾ã›ã‚“")
        } else {
            console.error(error)
        }
    }
    

}
/**/

/*æ™‚è¨ˆ*/
function newDate() {
    return getTimeInTimezone(Number(timezoneInput.value))
}

function getTimeInTimezone(utcOffset) {
    const now = new Date();
    const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000);
    const targetTime = new Date(utcTime + (3600000 * utcOffset));
    return targetTime;
}

function updateClock() {
    let time = newDate()
    let days = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"]
    let year = time.getFullYear()
    let month = time.getMonth()+1
    let date = time.getDate()
    let day = days[time.getDay()]
    let hour = time.getHours()
    let minute = time.getMinutes()
    let second = time.getSeconds()
    let mSecond = time.getMilliseconds()
    let utcString = String(timezoneInput.value)
    if (0<utcString) {utcString = "+"+utcString}
    clock.innerHTML = `${year}å¹´ ${month}æœˆ ${date}æ—¥ï¼ˆ${day}ï¼‰ ${hour}:${minute}:${second}:${mSecond} UTC${utcString}`
}

document.addEventListener("DOMContentLoaded",function() {
    const id = setInterval(() => {updateClock()},1000)
})
/**/

/*Class Statics*/
class Statics {
    constructor() {
    }

    setFile(file) {
        this.files = file
    }

    setStatics(json) {
        this.staticsJson = json
    }

    setSettings(json) {
        this.settingsJson = json
    }

    async load() {
        const staticText = await this.staticsJson.text()
        const settingText = await this.settingsJson.text()
        this.statics = JSON.parse(staticText)
        this.settings = JSON.parse(settingText)


    }
}
/**/

/*Class DB*/

class DB {
    constructor(dbName, dbVersion, stores) {
        this.dbName = dbName;
        this.dbVersion = dbVersion;
        // stores ã¯ { storeName: keyPath } ã®å½¢å¼ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æƒ³å®š
        this.stores = stores; 
        this.db = null;
    }

    async open() {
        if (this.db) return this.db;

        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.dbVersion);

            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                // å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ã‚¹ãƒˆã‚¢ã‚’ç¢ºèªãƒ»ä½œæˆ
                for (const [storeName, keyPath] of Object.entries(this.stores)) {
                    if (!db.objectStoreNames.contains(storeName)) {
                        db.createObjectStore(storeName, { keyPath });
                        console.debug(`Store created: ${storeName}`);
                    }
                }
            };

            request.onsuccess = (event) => {
                this.db = event.target.result;
                resolve(this.db);
            };

            request.onerror = () => reject(new Error("Database failed to open"));
        });
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’æŒ‡å®šã—ã¦ä¿å­˜
    async save(storeName, data) {
        await this.open();
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], "readwrite");
            const store = transaction.objectStore(storeName);

            const request = store.put(data);

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(new Error(`Failed to save to ${storeName}`));
        });
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’æŒ‡å®šã—ã¦å–å¾—
    async get(storeName, key) {
        await this.open();
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], "readonly");
            const store = transaction.objectStore(storeName);
            const request = store.get(key);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(new Error(`Failed to get from ${storeName}`));
        });
    }

    async getAll(storeName) {
        await this.open()
        return new Promise((resolve,reject) => {
            const transaction = this.db.transaction([storeName],"readonly")
            const store = transaction.objectStore(storeName)
            const request = store.getAll()
            request.onsuccess = () => resolve(request.result)
            request.onerror = (e) => reject(console.error(`DBã®å–å¾—ã‚¨ãƒ©ãƒ¼:${e}`))
            
        })
    }
}

/**/

/*ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿*/
document.addEventListener("DOMContentLoaded",async function() {/*ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã¨ãã«èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ã«ãƒ‘ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹*/
    const data = await db.get("InputFolderPath","path")
    document.getElementById("selectFolder").innerText = data.name || "ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ"
})

document.getElementById("selectFolder").addEventListener("click",async function() {/*èª­ã¿è¾¼ã¿ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®š*/
    try {
        const dirHandle = await window.showDirectoryPicker()

        await db.save("InputFolderPath",{
            path: "path",
            handle: dirHandle,
            name: dirHandle.name,
        })

        document.getElementById("selectFolder").innerText = dirHandle.name

        showAfterInput()
    } catch (e) {
        console.error(`ã‚¨ãƒ©ãƒ¼:${e}`)
    }
})

readFolder.addEventListener("click",async function() {/*ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ã*/
    try {
        document.getElementById("folderLoad").innerText = `èª­ã¿è¾¼ã¿é–‹å§‹`
        const data = await db.get("InputFolderPath","path")

        if (data && data.handle) {
            const permission = await data.handle.queryPermission({mode: "read" })

            if (permission === "granted" || await data.handle.requestPermission({mode: "read" }) === "granted") {
                const files = await getAllFiles(data.handle);
                //globals.save("files",files)
                load(files)
                document.getElementById("folderLoad").innerText = `èª­ã¿è¾¼ã¿å®Œäº†:${data.handle.name}`
                showAfterInput()
            }
        }
    } catch (error) {
        alert(`ã‚¨ãƒ©ãƒ¼:${error}\nãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™`)
        console.error(error)
    }

})

async function getAllFiles(dirHandle, path = '') {
    async function collectEntries(handle, currentPath) {
        const results = [];
        for await (const entry of handle.values()) {
            const newPath = currentPath ? `${currentPath}/${entry.name}` : entry.name;
            if (entry.kind === 'file') {
                results.push({ entry, newPath });
            } else if (entry.kind === 'directory') {
                const subResults = await collectEntries(entry, newPath);
                results.push(...subResults);
            }
        }
        return results;
    }

    const allEntries = await collectEntries(dirHandle, path);

    // ä¸€åº¦ã«å‡¦ç†ã™ã‚‹æ•°ã‚’åˆ¶é™ï¼ˆ5ã€œ20ã§èª¿æ•´ï¼‰
    const CHUNK_SIZE = 50;
    const files = [];

    for (let i = 0; i < allEntries.length; i += CHUNK_SIZE) {
        const chunk = allEntries.slice(i, i + CHUNK_SIZE);
        const chunkFiles = await Promise.all(chunk.map(async ({ entry, newPath }) => {
            const file = await entry.getFile();
            Object.defineProperty(file, 'relativePath', {
                value: newPath,
                writable: false
            });
            return file;
        }));
        files.push(...chunkFiles);

        // é€²æ—è¡¨ç¤ºï¼ˆä»»æ„ï¼‰
        document.getElementById("folderLoad").innerText = 
            `ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ä¸­[${Math.min(i + CHUNK_SIZE, allEntries.length)}/${allEntries.length}]`;
    }

    return files;
}

async function getPathOfInputFolder(filePathDB) {
    try {
        const dirHandle = await window.showDirectoryPicker()

        await db.save("InputFolderPath",{
            path: "path",
            handle: dirHandle,
            name: dirHandle.name,
        })

        document.getElementById("folderLoad").innerText = `èª­ã¿è¾¼ã¿å®Œäº†:${dirHandle.name}`

        showAfterInput()
    } catch (e) {
        console.error(`ã‚¨ãƒ©ãƒ¼:${e}`)
    }
}

async function load(files) {
    statics.setFile(files);

    const allData = await db.getAll("FilePlayed")
    const playedMap = new Map(allData.map(d => [d.path,d]))
    const fileMap = new Map(files.map(f=>[f.name,f]))//f.path?

    const musicFiles = files.filter(f => f.name !== "Settings.json" && f.name !== "Statics.json")

    const Settings = fileMap.get("Settings.json")
    const Statics = fileMap.get("Statics.json")

    if (!Settings) {alert("Settings.jsonãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")}
    if (!Statics) {alert("Statics.jsonãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")}

    const settingsText = await Settings.text()
    const staticsText = await Statics.text()

    const settingsJson = JSON.parse(settingsText)

    const staticsJson = JSON.parse(staticsText).map(track => {
        if (track.path) {
            const fileName = track.path.split(/[\\/]/).pop().replace(/\.[^/.]+$/,"")
            return {...track,path:fileName}
        }
        return track
    })


    statics.setSettings(settingsJson)
    statics.setStatics(staticsJson)
    loadSettings(settingsJson)

    const staticsMap = new Map(statics.staticsJson.map(j => [j.path,j]))



    let loaded = 0
    const total = musicFiles.length

    for (const m of musicFiles) {
        const fileName = m.name.replace(/\.[^/.]+$/,"")
        const d = playedMap.get(fileName)
        const json = staticsMap.get(fileName)

        const played = d ? (d.played ?? 0) : 0
        const lastPlayed = d ? d.lastPlayed : 0

        const _ = new Music(m,played,lastPlayed,json)
        music.push(_)
        loaded++

        if (loaded % 20 === 0 || loaded === total) {
            document.getElementById("folderLoad").innerText = `èª­ã¿è¾¼ã¿ä¸­[${loaded}/${total}]`
            await new Promise(resolve => setTimeout(resolve,0))
        }
    }

    console.log(music.musics)

    onFileLoaded()
}

function loadSettings(json) {
    const sceneSelectValue = json.sceneSelect
    const timeSignalValue = json.timeSignal
    const bgmValue = json.bgm
    const sceneSelectRangeValue = json.sceneSelectRange
    const timeZoneValue = json.timezone
    const betweenSongValue = json.betweenSong
    const leastToSignalValue = json.leastToSignal
    const leastPlayedValue = json.leastPlayed
    const timeBetweenPlayValue = json.timeBetweenPlay


    document.getElementById("sceneSelectBool").checked = sceneSelectValue
    document.getElementById("timeSignalBool").checked = timeSignalValue
    document.getElementById("bgmBool").checked = bgmValue
    document.getElementById("sceneSelectRange").value = sceneSelectRangeValue
    document.getElementById("timeZone").value = timeZoneValue
    document.getElementById("betweenSong").value = betweenSongValue/1000
    document.getElementById("leastToSignal").value = leastToSignalValue/1000
    document.getElementById("leastPlayed").value = leastPlayedValue
    document.getElementById("timeBetweenPlay").value = timeBetweenPlayValue
}
/**/


/*Class Globals - ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä»£ã‚ã‚Šã«ä¿å­˜ã™ã‚‹ã‚¯ãƒ©ã‚¹*/
class Globals {
    constructor() {
        this.data = []
    }

    save(key,data) {
        this.data.push({"key":key,"data":data})
    }

    get(key) {
        return this.data.find(data => data.key === key).data
    }
}

class Music {
    constructor(file,played=0,lastPlayed,json) {

        let fileName = file.name

        if (fileName.includes("%")) {
            try {
                fileName = decodeURIComponent(fileName)
            } catch (e) {
                console.error(`${fileName}ã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ`)
            }
        }
        fileName = fileName.split(/[\\/]/).pop().replace(/\.[^/.]+$/,"")

        this.type = json.type

        if (this.type === "bgm") {
            this.hour = json.hour
            this.file = file
        } else if (this.type === "music") {
            this.path = json.path
            this.name = json.name
            this.cover = json.cover
            this.original = json.original
            this.time = json.time
            this.signal = json.signal
            this.travel = json.travel
            this.travelOnly = json.travelOnly
            this.weather = json.weather
            this.registered = json.registered
            this.duration = json.duration
            this.source = json.source
            this.language = json.language
            this.played = played
            this.lastPlayed = lastPlayed
            this.file = file
        }
    }

    setPlayed(played) {
        this.played = played
    }

    setFile(file) {
        this.file = file
    }
}

class MusicManager {
    constructor() {
        this.musics = []
        this.signals = []
    }

    push(music) {
        this.musics.push(music)
        if (music.type === "music" && music.signal) {
            this.signals.push(music.signal)
        }
    }

    getBGMByHour(hour) {
        const result = this.musics.find(music => music.type === "bgm" && music.hour === hour)
        return result
    }

    getAllMusic() {
        const result = this.musics.filter(music => music.type === "music")
        return result
    }

    getHourlyMusic(hour,musics = this.musics) {
        const _musics = this.getMusicByType("music",false,musics)
        const range = Number(document.getElementById("sceneSelectRange").value)
        const hours = this.getHourRange(hour,range)

        const set = new Set(hours)
        const result = _musics.filter(music => music.time.some(item => set.has(item)))
        return result
    }

    getUnPlayedMusicByPlayed(times,musics = this.musics) {
        const leastPlayed = this.getLeastPlayed(musics).played || 0
        const maxAllowed = leastPlayed + times

        const _musics = this.getMusicByType("music",false,musics)

        const result = _musics.filter(music => {
            const p = music.played || 0
            return p >= leastPlayed && p <= maxAllowed
        })

        return result
    }

    getUnPlayedMusicByTime(minute,musics = this.musics) {
        const now = newDate()
        const past = newDate().setTime(now-60000*minute)
        const _musics = this.getMusicByType("music",false,musics)
        const result = _musics.filter(music => music.lastPlayed < past)
        return result
    }

    getMusicByTimeToItsSignal(minute,musics = this.musics) {
        const _musics = this.getMusicByType("music",false,musics)
        const now = newDate()
        const result = _musics.filter(music => {
            if (!music.signal) {return true}
            else {
                const time = this.getNextTime(music.signal)
                return time-now > minute*60000
            }
        })
        return result
    }

    getMusicByTimeToSignal(musics = this.musics) {
        const now = newDate()
        const nextSignal = this.getNextSignal().time
        const timeToSignal = nextSignal-now

        const betweenSong = Number(document.getElementById("betweenSong").value)*1000

        const _musics = this.getMusicByType("music",false,musics)
        const result = _musics.filter(music => music.duration + betweenSong + 1000 < timeToSignal)
        return result
    }

    chooseMusic(musics = this.musics) {
        const speed = getSpeed()
        const weather = getWeather()
        const _musics = this.getMusicByType("music","any",musics)

        let list = []

        for (const music of _musics) {
            if (music.travelOnly === true) {
                undefined
            } else 
            if (weather === "Clear" && music.weather.includes("Clear")) {
                for (let i=0;i<2;i++) {
                    list.push(music)
                }
            } else
            if (weather === "Clouds" && music.weather.includes("Clouds")) {
                for (let i=0;i<2;i++) {
                    list.push(music)
                }
            } else
            if (weather === "Rain" && music.weather.includes("Rain")) {
                for (let i=0;i<5;i++) {
                    list.push(music)
                }
            } else 
            if (weather === "Snow" && music.weather.includes("Snow")) {
                for (let i=0;i<10;i++) {
                    list.push(music)
                }
            } else {
                list.push(music)
            }
        }

        if (20 < speed) {
            for (const music of _musics) {
                if (music.travel === true) {
                    for (let i=0;i<2;i++) {
                        list.push(music)
                    }
                }
            }
        }

        const randomIndex = Math.floor(Math.random()*list.length)
        const selected = list[randomIndex]
        return selected
    }

    getNextSignal() {
        let signal = []
        let timeLeft = undefined
        const now = newDate()
        for (const music of this.musics) {
            if (music.signal) {
                const time = this.getNextTime(music.signal)
                signal.push({time:time,music:music})
            }
        }
        let least = signal[0].time - now
        let nextSignal = signal[0].time
        let signalMusic = signal[0].music
        for (const date of signal) {
            if (date.time - now > 0 && date.time - now < least) {
                least = date.time - now
                nextSignal = date.time
                signalMusic = date.music
            }
        }
        console.log(`nextSignal:${nextSignal},play${signalMusic.name}`)
        return {time:nextSignal,music:signalMusic}

    }

    getNextTime(hhmm) {
        const hour = Number(hhmm.slice(0,2))
        const minute = Number(hhmm.slice(2,4))

        const now = newDate()
        const time = new Date(now)

        const timezone = Number(document.getElementById("timeZone").value)

        time.setHours(hour)
        time.setMinutes(minute)
        time.setSeconds(0)
        time.setMilliseconds(0)

        if (time.getTime() <= now.getTime()) {
            time.setDate(time.getDate()+1)
        }

        return time
    }

    getLeastPlayed(musics = this.musics) {
        const _musics = this.getMusicByType("music",false,musics)

        let least = _musics[0].played
        let leastMusic = _musics[0]
        for (const music of _musics) {
            if (music.played < least) {
                least = music.played
                leastMusic = music
            }
        }
        return leastMusic
    }

    getHourRange(hour,range) {
        const max = hour+range
        const min = hour-range
        let hours = Array.from({length:range*2+1},(_,i) => min+i)
        return hours.map(h => {
            return (h+24)%24
        })
    }

    getMusicByType(type,travelOnly,musics = this.musics) {
        
        if (typeof travelOnly === "boolean"){
            const result = musics.filter(music => music.type === type && music.travelOnly === travelOnly)
            return result
        } else {
            const result = musics.filter(music => music.type === type)
            return result
        }
    }

    async savePlayed(name) {

        if (document.getElementById("sleepMode").checked) {return}

        const index = this.musics.find(music => music.path === name)
        console.debug(`savePlayed`)
        console.debug(index)
        const played = index.played ?? 0
        console.debug(`played:${played} + 1`)
        index.played++
        index.lastPlayed = newDate().getTime()
        console.debug(`lastPlayed:${index.lastPlayed}`)
        await db.save("FilePlayed",{
            "path":name,
            "played":played+1,
            "lastPlayed":newDate().getTime()
        })
    }

}



const globals = new Globals()
const db = new DB("MusicPlayerDB_61",2,{
    "FilePlayed":"path",
    "InputFolderPath":"path",
})
const music = new MusicManager()
const statics = new Statics()



/*function play*/
async function play(place,musicFile) {
    const url = URL.createObjectURL(musicFile.file)
    const lowerName = musicFile.file.name.toLowerCase()
    if (place === "b") {
        audioB.style.display = "none"
        videoB.style.display = "none"
        audioB.pause()
        videoB.pause()
        const now = newDate()
        if (lowerName.endsWith('.mp3') || lowerName.endsWith('.m4a')) {
            audioB.src = url;
            audioB.style.display = 'block';
            changeVolume()
            await audioB.play();
            audioB.currentTime = now.getMinutes()*60+now.getSeconds()+now.getMilliseconds()/1000
        } else if (lowerName.endsWith('.webm') || lowerName.endsWith('.mkv') || lowerName.endsWith(".mp4")) {
            videoB.src = url;
            videoB.style.display = 'block';
            changeVolume()
            await videoB.play();
        }
    } else if (place === "m") {
        music.savePlayed(musicFile.path)
        setProperty(musicFile)
        setMetadata(musicFile)
        audioM.style.display = "none"
        videoM.style.display = "none"
        audioM.pause()
        videoM.pause()
        document.getElementById("nowPlaying").textContent = "å†ç”Ÿä¸­: " + musicFile.file.name.replace(/\.[^/.]+$/, "");
        document.title = musicFile.file.name.replace(/\.[^/.]+$/, "")
        if (lowerName.endsWith('.mp3') || lowerName.endsWith('.m4a')) {
            audioM.src = url;
            audioM.style.display = 'block';
            changeVolume()
            await audioM.play();
        } else if (lowerName.endsWith('.webm') || lowerName.endsWith('.mkv') || lowerName.endsWith(".mp4")) {
            videoM.src = url;
            videoM.style.display = 'block';
            changeVolume()
            await videoM.play();
        }
    } else if (place === "j") {
        music.savePlayed(musicFile.path)
        setProperty(musicFile)
        setMetadata(musicFile)
        const now = newDate()
        if (now.getMinutes() === 0) {
            playBeep("C6")
        } else if (now.getMinutes() === 15) {
            playBeep("C5")
        } else if (now.getMinutes() === 30) {
            playBeep("E5")
        } else if (now.getMinutes() === 45) {
            playBeep("G5")
        }

        audioJ.style.display = "none"
        videoJ.style.display = "none"
        audioJ.pause()
        videoJ.pause()
        document.getElementById("nowPlaying").textContent = "å†ç”Ÿä¸­: " + musicFile.file.name.replace(/\.[^/.]+$/, "");
        document.title = musicFile.file.name.replace(/\.[^/.]+$/, "")
        if (lowerName.endsWith('.mp3') || lowerName.endsWith('.m4a')) {
            audioJ.src = url;
            audioJ.style.display = 'block';
            changeVolume()
            await audioJ.play();
        } else if (lowerName.endsWith('.webm') || lowerName.endsWith('.mkv') || lowerName.endsWith(".mp4")) {
            videoJ.src = url;
            videoJ.style.display = 'block';
            changeVolume()
            await videoJ.play();
        }
    }
}

async function playBeep(freq) {
    const available = ["C5","E5","G5","C6"]
    if (!available.includes(freq)) {
        console.error(`${freq}ã¯å†ç”Ÿã§ãã¾ã›ã‚“`)
        return
    }

    const fileURL = `SE/${freq}Beep.wav`
    audioSE.src = fileURL

    try {
        audioSE.currentTime = 0
        await audioSE.play()
    } catch (e) {
        console.error(e)
    }

}

function playBGM() {
    const now = newDate()
    const bgm = music.getBGMByHour(now.getHours())
    if (bgm == null) {
        alert("BGMãŒã‚ã‚Šã¾ã›ã‚“")
        return
    }
    play("b",bgm)
}

audioB.onended = videoB.onended = () => {
    audioB.style.display = "none";
    videoB.style.display = "none;";
    playBGM()
    changeVolume()
}

audioM.onended = videoM.onended = () => {
    audioM.style.display = "none";
    videoM.style.display = "none";
    haveSetMusic = false
    if (!isInSleepMode) {
        playMusic()
    }
    changeVolume()
}

audioJ.onended = videoJ.onended = () => {
    audioJ.style.display = "none";
    videoJ.style.display = "none";
    haveSetSignal = false
    if (!isInSleepMode) {
        setSignal()
        playMusic()
    }
    changeVolume()
}

function resetIdleTimer() {
    if (isInSleepMode) {
        document.getElementById("sleepModeMessage").innerText = "ä¼‘æ­¢ãƒ¢ãƒ¼ãƒ‰ã¯ç„¡åŠ¹ã§ã™"
        isInSleepMode = false
        setSignal()
        playMusic()
        clearTimeout(idleTimer)
        idleTimer = setTimeout(activateIdleMode,Number(document.getElementById("sleepModeInput").value)*60*1000)
    }
}

function activateIdleMode() {
    isInSleepMode = true
    document.getElementById("sleepModeMessage").innerText = "ä¼‘æ­¢ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã™"
}


function setProperty(music) {
    document.getElementById("pathDialog").innerText = `${music.path}`
    document.getElementById("nameDialog").innerText = `name:${music.name}`
    document.getElementById("coverDialog").innerText = `cover:${music.cover}`
    document.getElementById("originalDialog").innerText = `original:${music.original}`
    document.getElementById("timeDialog").innerText = `time:${music.time}`
    document.getElementById("signalDialog").innerText = `signal:${music.signal}`
    document.getElementById("travelDialog").innerText = `travel:${music.travel}`
    document.getElementById("travelOnlyDialog").innerText = `travelOnly:${music.travelOnly}`
    document.getElementById("weatherDialog").innerText = `weather:${music.weather}`
    document.getElementById("durationDialog").innerText = `duration:${music.duration/1000}`
    document.getElementById("registeredDialog").innerText = `registered:${music.registered}`
    document.getElementById("languageDialog").innerText = `language:${music.language}`
    document.getElementById("playedDialog").innerText = `played:${music.played}`
    document.getElementById("sourceDialog").href = music.source
    document.getElementById("sourceDialog").innerText = music.source


}

function playMusic() {
    /*
ã€€å¤©å€™ãƒ–ãƒ¼ã‚¹ãƒˆã§ãã®æ›²ãŒä»»æ„ã®å€ç‡é¸ã°ã‚Œã‚„ã™ããªã‚‹
éŸ³æ¥½ã®ãƒ©ãƒ³ãƒ€ãƒ å†ç”Ÿã‚·ã‚¹ãƒ†ãƒ ã®ä¿®æ­£
ã€€æ™‚é–“å¸¯ã«ã‚ã£ãŸæ›²ã‚’é¸ã¶ done
ã€€å†ç”Ÿå›æ•°ãŒå°‘ãªã„ã‚‚ã®ã‚’é¸ã¶ done
ã€€æ™‚å ±ãŒè¿‘ãã«ãªã„ã‚‚ã®ã‚’é¸ã¶ done 
ã€€æ™‚å ±ã¾ã§ã®æ™‚é–“ï¼‹Î±ã‚ˆã‚ŠçŸ­ã„ã‚‚ã®ã‚’é¸ã¶  done
ã€€æœ€è¿‘å†ç”Ÿã•ã‚Œã¦ã„ãªã„ã‚‚ã®ã‚’é¸ã¶ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰ done
ã€€ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶ done
    */

    if (haveSetMusic) {return}

    const now = newDate()

    const allMusic = music.getAllMusic()
    if (allMusic == null) {
        alert("éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“")
        return
    }

    let hourlyMusic = undefined
    if (document.getElementById("sceneSelectBool").checked) {
        hourlyMusic = music.getHourlyMusic(newDate().getHours(),allMusic)

        if (hourlyMusic.length === 0) {
            console.error("æ™‚é–“å¸¯ã«ä¸€è‡´ã™ã‚‹æ›²ãŒãªã„ã®ã§ã™ã¹ã¦ã®æ›²ã‚’ä½¿ã„ã¾ã™")
            hourlyMusic = allMusic
        }
    }

    let unPlayedMusic = music.getUnPlayedMusicByPlayed(document.getElementById("leastPlayed").value-0,hourlyMusic)
    if (unPlayedMusic.length === 0) {
        console.error("è¨­å®š å†ç”Ÿå›æ•°ãŒæœ€ã‚‚å°‘ãªã„ã‚‚ã®ã‹ã‚‰ä½•å›å¤šã„ã‚‚ã®ã¾ã§è¨±å®¹ã™ã‚‹ã‹ã®å€¤ãŒä¸æ­£ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™")
        unPlayedMusic = hourlyMusic
    }

    let temp = unPlayedMusic
    unPlayedMusic = music.getUnPlayedMusicByTime(document.getElementById("timeBetweenPlay").value-0,temp)
    if (unPlayedMusic.length === 0) {
        console.error("ã—ã°ã‚‰ãå‰ã«å†ç”Ÿã•ã‚ŒãŸæ›²ãŒã‚ã‚Šã¾ã›ã‚“")
        unPlayedMusic = temp
    }

    let noSignalMusic = undefined
    if (document.getElementById("timeSignalBool").checked) {
        noSignalMusic = music.getMusicByTimeToItsSignal(document.getElementById("timeBetweenPlay").value-0,unPlayedMusic)
            if (noSignalMusic.length === 0) {
                console.error("æ™‚å ±ã¾ã§ã®æ™‚é–“ãŒã‚ã‚‹æ›²ãŒã‚ã‚Šã¾ã›ã‚“")
                noSignalMusic = unPlayedMusic
            }
    }

    let shortMusic = music.getMusicByTimeToSignal(noSignalMusic)
    if (shortMusic.length === 0) {
        //æ™‚å ±ã¾ã§ã®æ™‚é–“ãŒçŸ­ã„ã®ã§æ›²ãŒãªã„
    }ã€€else {
        const playMusic = music.chooseMusic(shortMusic)
        const betweenSong = Number(document.getElementById("betweenSong").value)
        console.debug(`æ¬¡ã«å†ç”Ÿ:${playMusic.name},${betweenSong}ç§’å¾Œ`)
        setTimeout(play,betweenSong*1000,"m",playMusic)
        haveSetMusic = true
    }
}

function setSignal() {
    if (haveSetSignal) {return}
    const nextSignal = music.getNextSignal()
    const time = music.getNextTime(nextSignal.music.signal)
    const now = newDate()
    const timeToSignal = time - now

    setTimeout(play,timeToSignal,"j",nextSignal.music)
    haveSetSignal = true
}

function getWeather() {
    if (document.getElementById("weatherInternet").checked) {
        //ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰å¤©æ°—ã‚’å–å¾—
        console.log("ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰å¤©æ°—ã‚’å–å¾—ã™ã‚‹éƒ¨åˆ†ãŒæœªå®Œ")
        return "None"
    } else {
        return ["None","Clear","Clouds","Rain","Snow"][Number(document.getElementById("weatherInput").value)]
    }
}

function getSpeed() {
    if (document.getElementById("speedInternet").checked) {
        //ã“ã“ã¯å®Œæˆã•ã›ã‚‹ã¤ã‚‚ã‚Šã¯ãªã„
    } else {
        return Number(document.getElementById("speedInput").value)
    }
}

function setMetadata(music) {
    if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
            title: music.name,
            artist: music.cover,
            artwork: [{ src: 'icons/icon-512.png', sizes: '512x512', type: 'image/png' }]
    });

        // å†ç”Ÿãƒ»ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³ã‚’ã‚·ã‚¹ãƒ†ãƒ ã¨é€£æºã•ã›ã‚‹
        navigator.mediaSession.setActionHandler('play', () => {audioM.play();videoM.play();audioJ.play();videoJ.play();});
        navigator.mediaSession.setActionHandler('pause', () => {audioM.pause();videoM.pause();audioJ.pause();videoJ.pause();});
}
}

document.getElementById("muteCheckBox").addEventListener("click",changeVolume,1-Number(document.getElementById("muteCheckBox").checked)
)

function changeVolume(volarg=undefined) {
    const barVolume = Number(document.getElementById("volumeBar").value)/100
    const inputVolume = Number(document.getElementById("volumeInput").value)/100
    const checkbox = document.getElementById("muteCheckBox").checked

    if (volarg) {
        document.getElementById("volumeInput").value = volarg
        document.getElementById("volumeBar").value = volarg
    }

    let isPlaying = undefined
    const volume = Number(document.getElementById("volumeBar").value)/100

    const videoM_Display = window.getComputedStyle(videoM).display
    const audioM_Display = window.getComputedStyle(audioM).display
    const videoJ_Display = window.getComputedStyle(videoJ).display
    const audioJ_Display = window.getComputedStyle(audioJ).display

    if (videoM_Display === "block" || audioM_Display === "block" || videoJ_Display == "block" || audioJ_Display == "block") {
        isPlaying = true
    }else {
        isPlaying = false
    }

    // isPlaying,inSleepMode
    //f,f->1 1:mjVol=1,bVol=0
    //t,f->0 0:mjVol=0,bVol=1
    //f,t->0
    //f,f->1

    const bool = Math.abs(isPlaying-inSleepMode)   
    
    //bool:BGMã‚’æµã™ã¹ãæ™‚ã«1

    let bVol =   bool*!checkbox*volume
    let mjVol = !bool*!checkbox*volume
    let seVol =       !checkbox*volume

    audioB.volume = bVol
    videoB.volume = bVol
    audioM.volume = mjVol
    videoM.volume = mjVol
    audioJ.volume = mjVol
    videoJ.volume = mjVol
    audioSE.volume = seVol

    document.getElementById("volume").innerText = `BGM:${bVol*100}\nMusic:${mjVol*100}`
}

document.getElementById("volumeBar").addEventListener("input",function() {
    changeVolume(Number(document.getElementById("volumeBar").value))
})

document.getElementById("volumeInput").addEventListener("input",function() {
    changeVolume(Number(document.getElementById("volumeInput").value))
})

startButton.addEventListener("click",function() {
    onStarted()
    playMusic()
    if (document.getElementById("timeSignalBool").checked) {
        setSignal()
    }
    if (document.getElementById("bgmBool").checked) {
        playBGM()
    }
    if (document.getElementById("sleepMode").checked) {
        isInSleepMode = true
        resetIdleTimer();
        ["mousemove","mousedown","keydown","touchstart"].forEach(e => {
            window.addEventListener(e,resetIdleTimer,{passive:true})
        })
    }
})



    </script>
</html>